
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vercel KV ‰∏âÁõÆ‰∏¶„Åπ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cell {
            transition: background-color 0.2s ease-in-out;
        }
        .cell:hover:not(.x):not(.o) {
            background-color: #f0f0f0; /* Light gray for hover on empty cells */
        }
        .cell.x::before {
            content: 'X';
            font-size: 4rem;
            color: #3b82f6; /* blue-500 */
        }
        .cell.o::before {
            content: 'O';
            font-size: 4rem;
            color: #ef4444; /* red-500 */
        }
    </style>
<script type="importmap">
{
  "imports": {
    "@vercel/kv": "https://aistudiocdn.com/@vercel/kv@^3.0.0"
  }
}
</script>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center justify-center min-h-screen font-sans p-4">

    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
        <h1 class="text-3xl sm:text-4xl font-bold mb-2">„Ç™„É≥„É©„Ç§„É≥‰∏âÁõÆ‰∏¶„Åπ</h1>
        <p class="text-gray-500 mb-6">Vercel KV & Functions Demo</p>

        <div id="game-info" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <p id="status" class="text-lg font-semibold text-blue-800">„Ç≤„Éº„É†„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            <div id="game-id-container" class="hidden mt-2">
                <p class="text-sm text-gray-600">„Ç≤„Éº„É†ID (Áõ∏Êâã„Å´ÂÖ±Êúâ):</p>
                <input id="share-url" type="text" readonly class="w-full bg-gray-100 text-center p-2 rounded border border-gray-300 font-mono text-sm mt-1 cursor-pointer">
            </div>
        </div>

        <div id="board" class="grid grid-cols-3 gap-3 w-full aspect-square mb-6 pointer-events-none opacity-50">
            <!-- Cells will be generated by JavaScript -->
        </div>

        <button id="new-game-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
            Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†„ÇíÈñãÂßã„Åô„Çã
        </button>
    </div>

    <footer class="mt-8 text-center text-gray-500 text-sm">
        <p>No Frameworks, No Build Tools. Just HTML, JS, and Vercel.</p>
    </footer>

    <script>
        const boardElement = document.getElementById('board');
        const statusElement = document.getElementById('status');
        const newGameButton = document.getElementById('new-game-btn');
        const gameIdContainer = document.getElementById('game-id-container');
        const shareUrlInput = document.getElementById('share-url');

        let gameState = {
            gameId: null,
            player: null,
            pollingInterval: null,
        };

        const createBoard = () => {
            boardElement.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell bg-gray-200 w-full h-full rounded-lg flex items-center justify-center cursor-pointer';
                cell.dataset.index = i;
                cell.addEventListener('click', handleCellClick);
                boardElement.appendChild(cell);
            }
        };

        const updateUI = (state) => {
            // Update board cells
            state.board.forEach((value, index) => {
                const cell = boardElement.children[index];
                cell.classList.remove('x', 'o');
                if (value) {
                    cell.classList.add(value.toLowerCase());
                }
            });

            // Update status message
            let statusText = '';
            const isMyTurn = state.turn === gameState.player;
            const isGameOver = state.status.startsWith('win') || state.status === 'draw';

            if (state.status === 'waiting') {
                statusText = gameState.player === 'X' ? '„Éó„É¨„Ç§„É§„ÉºO„ÅÆÂèÇÂä†„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...' : '„Ç≤„Éº„É†„Å´ÂèÇÂä†„Åó„Åæ„Åó„ÅüÔºÅ';
            } else if (isGameOver) {
                if (state.status === 'draw') {
                    statusText = 'Âºï„ÅçÂàÜ„Åë„Åß„ÅôÔºÅ';
                } else {
                    const winner = state.status.split('_')[1];
                    statusText = winner === gameState.player ? '„ÅÇ„Å™„Åü„ÅÆÂãù„Å°„Åß„ÅôÔºÅ üéâ' : '„ÅÇ„Å™„Åü„ÅÆË≤†„Åë„Åß„Åô...';
                }
            } else {
                statusText = isMyTurn ? '„ÅÇ„Å™„Åü„ÅÆÁï™„Åß„Åô' : 'Áõ∏Êâã„ÅÆÁï™„Åß„Åô';
            }
            statusElement.textContent = statusText;

            // Enable/disable board
            if (isMyTurn && !isGameOver) {
                boardElement.classList.remove('pointer-events-none', 'opacity-50');
            } else {
                boardElement.classList.add('pointer-events-none', 'opacity-50');
            }
        };

        const pollGameState = async () => {
            if (!gameState.gameId) return;
            try {
                const response = await fetch(`/api/game/state?id=${gameState.gameId}`);
                if (response.ok) {
                    const state = await response.json();
                    updateUI(state);
                } else {
                    console.error('Failed to poll game state:', response.statusText);
                    stopPolling();
                }
            } catch (error) {
                console.error('Error during polling:', error);
                stopPolling();
            }
        };

        const startPolling = () => {
            stopPolling(); // Ensure no multiple intervals are running
            pollGameState(); // Initial poll
            gameState.pollingInterval = setInterval(pollGameState, 2000);
        };
        
        const stopPolling = () => {
            if (gameState.pollingInterval) {
                clearInterval(gameState.pollingInterval);
                gameState.pollingInterval = null;
            }
        };
        
        const handleCellClick = async (event) => {
            const index = parseInt(event.target.dataset.index, 10);
            if (isNaN(index)) return;

            try {
                const response = await fetch('/api/game/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        gameId: gameState.gameId,
                        player: gameState.player,
                        index: index
                    }),
                });
                if (response.ok) {
                    const newState = await response.json();
                    updateUI(newState);
                } else {
                    const error = await response.json();
                    alert(`„Ç®„É©„Éº: ${error.message}`);
                }
            } catch (error) {
                console.error('Failed to make move:', error);
                alert('ÊâãÁï™„ÇíÂá¶ÁêÜ„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
            }
        };

        const handleNewGameClick = async () => {
            newGameButton.disabled = true;
            newGameButton.textContent = '‰ΩúÊàê‰∏≠...';
            try {
                const response = await fetch('/api/game/create', { method: 'POST' });
                const data = await response.json();
                
                // Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†ID„ÅßURL„ÇíÊõ¥Êñ∞
                const newUrl = `${window.location.origin}${window.location.pathname}?gameId=${data.gameId}`;
                window.history.pushState({ path: newUrl }, '', newUrl);

                // „Ç≤„Éº„É†Áä∂ÊÖã„ÇíÂàùÊúüÂåñ
                initGame();
            } catch (error) {
                console.error('Failed to create new game:', error);
                alert('Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            } finally {
                newGameButton.disabled = false;
                newGameButton.textContent = 'Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†„ÇíÈñãÂßã„Åô„Çã';
            }
        };

        const initGame = () => {
            createBoard();
            const urlParams = new URLSearchParams(window.location.search);
            const gameIdFromUrl = urlParams.get('gameId');

            if (gameIdFromUrl) {
                gameState.gameId = gameIdFromUrl;
                gameState.player = 'O';
                newGameButton.style.display = 'none'; // Hide new game button when joining
                gameIdContainer.classList.remove('hidden');
                shareUrlInput.value = window.location.href;
                startPolling();
            } else {
                gameState.player = 'X';
                // No game ID yet, wait for user to click "New Game"
                stopPolling();
            }
        };

        // --- Event Listeners ---
        newGameButton.addEventListener('click', handleNewGameClick);
        shareUrlInput.addEventListener('click', () => {
            shareUrlInput.select();
            navigator.clipboard.writeText(shareUrlInput.value)
                .then(() => alert('URL„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ'))
                .catch(err => console.error('Copy failed', err));
        });

        // --- Initial Load ---
        initGame();
    </script>
</body>
</html>
